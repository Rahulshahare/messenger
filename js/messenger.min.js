$(document).ready((function(){console.log("Lets Begin");let e=[];var s,n,t=[],a="",o="",i="";$("#scrollingComponent").scroll((function(){$("#scrollingComponent").scrollTop()})),s=function(e){for(var s=e+"=",n=document.cookie.split(";"),t=0;t<n.length;t++){for(var a=n[t];" "==a.charAt(0);)a=a.substring(1,a.length);if(0==a.indexOf(s))return a.substring(s.length,a.length)}return null}("userId"),console.log(s),p(),s&&(n=s,$.ajax({url:"api/get_user_details.php",data:{userId:n},success:function(s){e=s,l()},error:function(){alert("There was an error.")}}));const r=e=>{const s=$(`#${e}`);s.animate({scrollTop:s.prop("scrollHeight")},500)};function l(){if(e){const h=JSON.parse(e);x=h.id;var n=document.getElementById("UserList");for(let e=0;e<h.length;e++){var t=h[e].id,i=(f=h[e].full_name).charAt(0).toUpperCase()+f.slice(1),r=h[e].profile_pic,l=h[e].online,c=h[e].last_login,g=h[e].register_on,p=1==l?"success":"secondary",u=1==l?"Active now":""==c?time_ago(g):time_ago(c);n.innerHTML+='<a href="#" id="'+t+'" data-id="'+t+'"  class="UserInList list-group-item list-group-item-action"><div class="container"><div class="row"><div class="col-3 position-relative text-center" style="padding: 0;"><div><img src="usericons/'+r+'" class="img-fluid " style="width: 80%;"/><span class="position-absolute bottom-0  translate-middle p-2 bg-'+p+' border border-light rounded-circle" style="border: 3px solid #fff !important;"><span class="visually-hidden">New alerts</span></span></div></div><div class="col-9" style="padding: 10px;"><p style="margin: 0;font-weight: 500;font-size: 15px;">'+i+'</p><span class="text-secondary" style="font-size: 12px;font-weight: 500;">'+u+"</span></div></div></div></a>"}for(var m in $(".UserInList").click((function(){return a=this.id,function(){e||console.log("ERROR WHILE SETTING NAME");const s=JSON.parse(e);var n=document.getElementById("User_two_details");n.innerHTML="";for(let e=0;e<s.length;e++){var t=s[e].id;if(a==t){console.log("user 2 is "+a);var o=s[e].full_name,i=s[e].online,r=(s[e].last_login,s[e].register_on,1==i?'<span class="badge rounded-pill bg-primary">online</span>':'<span class="badge rounded-pill bg-light text-dark">offline</span>');n.innerHTML+=o.toUpperCase()+" "+r}}}(),n=s,a&&n?$.ajax({type:"POST",url:"api/get_conversation_id.php",data:{user_one:n,user_two:a},success:function(e){o=e,d()},error:function(){alert("There was an error.")}}):alert("ERROR WHILE GETTING CONVERSATION ID"),$("#msgBox").hasClass("d-none")&&($("#introBox").addClass("d-none"),$("#msgBox").removeClass("d-none")),$(".UserInList").hasClass("active")?$(".UserInList").removeClass("active"):$("#"+this.id).addClass("active"),!1;var n})),h)for(var v=0;v<h[m].length;v++)console.log(data[m][v].profile_pic)}var f}function d(){o?$.ajax({type:"POST",url:"api/get_messages.php",data:{conversation_id:o},success:function(e){t=e;JSON.parse(e);g(),r("scrollingComponent")},error:function(){alert("There was an error.")}}):console.log("ERROR WHILE GETTING INITIAL MESSAGES")}function c(e=null){var n;n=e||document.getElementById("messenger-text").value,document.getElementById("messenger-text").value="",o&&s&&a&&""!=n?(n=encodeURIComponent(n),$.ajax({type:"POST",url:"api/send_message.php",data:{user_one:s,user_two:a,conversation_id:o,message:n},success:function(e){console.log("STATUS::"+e.trim()),p()},error:function(){alert("There was an error.")}})):console.log("STATUS::ERROR WHILE SENDING MESSAGE")}function g(){if(t){const g=JSON.parse(t);var e=document.getElementById("Messagebox");e.innerHTML="";var n=g.length-1;if(null==g.length&&(e.innerHTML+='<h2 class="text-center">Say hi to start conversation</h2>'),null!=g.length){n=g.length-1;i=g[n].id;for(let n=0;n<g.length;n++){g[n].conversation_id;var a=g[n].id,o=g[n].message,r=(g[n].message,g[n].timestamp),l=g[n].user_from;g[n].user_to;if(1==o.includes("Image::")){var d=o.replace("Image::","");o='<a data-fancybox="gallery" href="#" data-src="uploads/'+d+'"><img  src="uploads/'+d+'" class="img-fluid" /></a>'}var c=time_ago(r);e.innerHTML+=l==s?'<li class="list-group-item msgbox"><div id="'+a+'" class="msgText msgright" style="padding:10px;position: relative;border: 1px solid #e2e0e0";><div class="msg"><div class="preWrap">'+o+'</div></div><div class="secondary-text mt-1" title=" '+r+' ">'+c+' </div><a class="DeleteMsg delete-msg  text-danger fst-italic mt-1" id="'+a+'">delete </a></div></li>':'<li class="list-group-item msgbox"><div id="'+a+'" class="msgText msgleft" style="max-width: 80%;padding: 10px;display: block;position: relative;border: 1px solid #cecece";><div class="msg"><div class="preWrap">'+o+'</div></div><span class="secondary-text mt-1" title=" '+r+' ">'+c+" </span></div></li>"}}}else console.log("ERROR IN SHOWING MESSAGE");$(".DeleteMsg").click((function(){msg_id=this.id,console.log(msg_id)}))}function p(){o?i?$.ajax({type:"POST",url:"api/get_new_message.php",data:{conversation_id:o,last_message_id:i},success:function(e){if(console.log(e),null!=JSON.parse(e).length){var s=JSON.parse(t),n=JSON.parse(e);for(let e=0;e<n.length;e++)s.push(n[e]);t=JSON.stringify(s),r("scrollingComponent"),g()}},error:function(){alert("There was an error.")}}):d():console.log("STATUS::ANATHER USER NOT SELECTED"),setTimeout(p,5e3)}$(".sendButton").click((function(){""!=document.getElementById("messenger-text").value.trim()?(c(),$("#Imagepicker").hasClass("d-none")&&($("#Imagepicker").removeClass("d-none"),$("#Sendbutton").addClass("d-none"))):(document.getElementById("messenger-text").value="",$("#Imagepicker").hasClass("d-none")&&($("#Imagepicker").removeClass("d-none"),$("#Sendbutton").addClass("d-none")))})),$("#messenger-text").bind("input propertychange",(function(){this.value.length?$("#Sendbutton").hasClass("d-none")&&($("#Sendbutton").removeClass("d-none"),$("#Imagepicker").addClass("d-none")):$("#Imagepicker").hasClass("d-none")&&($("#Imagepicker").removeClass("d-none"),$("#Sendbutton").addClass("d-none"))})),document.getElementById("send_image").onchange=function(){var e=this.files[0],s=new FormData;s.append("userImage",e),e&&(console.log(e),$.ajax({type:"POST",url:"upload.php",data:s,processData:!1,contentType:!1,success:function(e){console.log("Image::"+e),c(picture="Image::"+e)},error:function(){alert("There was an error.")}}))},Fancybox.bind('[data-fancybox="gallery"]',{infinite:!1})}));