$(document).ready(function(){console.log("Lets Begin");let e=[];var s,n=[],t="",a="",i="",r="";function o(e){console.log(e)}$("#scrollingComponent").scroll(function(){$("#scrollingComponent").scrollTop()}),t=function e(s){for(var n=s+"=",t=document.cookie.split(";"),a=0;a<t.length;a++){for(var i=t[a];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(n))return i.substring(n.length,i.length)}return null}("userId"),console.log(t),m(),t&&(s=t,$.ajax({url:"api/get_user_details.php",data:{userId:s},success:function(s){e=s,function s(){if(e){let n=JSON.parse(e);x=n.id;var r=document.getElementById("UserList");for(let o=0;o<n.length;o++){var l=n[o].id,g=d(n[o].full_name),p=n[o].profile_pic,u=n[o].online,m=n[o].last_login,v=n[o].register_on,f=1==u?"success":"secondary",h=1==u?"Active now":""==m?time_ago(v):time_ago(m);r.innerHTML+='<a href="#" id="'+l+'" data-id="'+l+'"  class="UserInList list-group-item list-group-item-action"><div class="container"><div class="row"><div class="col-md-3 col-12 position-relative text-center" style="padding: 0;"><div><img src="usericons/'+p+'" title=" '+g+'" class="img-fluid " style="width: 80%;"/><span class="position-absolute bottom-0  translate-middle p-2 bg-'+f+' border border-light rounded-circle" style="border: 3px solid #fff !important;"><span class="visually-hidden">New alerts</span></span></div></div><div class="col-9 d-none  d-md-block" style="padding: 10px;"><p style="margin: 0;font-weight: 500;font-size: 15px;">'+g+'</p><span class="text-secondary" style="font-size: 12px;font-weight: 500;">'+h+"</span></div></div></div></a>"}for(var I in $(".UserInList").click(function(){var s;return a=this.id,function s(){e||console.log("ERROR WHILE SETTING NAME");let n=JSON.parse(e);var t=document.getElementById("User_two_details");t.innerHTML="";for(let i=0;i<n.length;i++)if(a==n[i].id){console.log("user 2 is "+a);var r=n[i].full_name,o=n[i].online;n[i].last_login,n[i].register_on;var l=1==o?'<span class="badge rounded-pill bg-primary">online</span>':'<span class="badge rounded-pill bg-light text-dark">offline</span>';t.innerHTML+=r.toUpperCase()+" "+l}}(),s=t,a&&s?$.ajax({type:"POST",url:"api/get_conversation_id.php",data:{user_one:s,user_two:a},success:function(e){i=e,c()},error:function(){alert("There was an error.")}}):alert("ERROR WHILE GETTING CONVERSATION ID"),$("#msgBox").hasClass("d-none")&&($("#introBox").addClass("d-none"),$("#msgBox").removeClass("d-none")),$(".UserInList").hasClass("active")?$(".UserInList").removeClass("active"):$("#"+this.id).addClass("active"),!1}),n)for(var T=0;T<n[I].length;T++)console.log(data[I][T].profile_pic)}}()},error:function(){alert("There was an error.")}}));let l=e=>{let s=$(`#${e}`);s.animate({scrollTop:s.prop("scrollHeight")},500)};function d(e){return e.charAt(0).toUpperCase()+e.slice(1)}function c(){i?$.ajax({type:"POST",url:"api/get_messages.php",data:{conversation_id:i},success:function(e){n=e,JSON.parse(e),u(),l("scrollingComponent")},error:function(){alert("There was an error.")}}):console.log("ERROR WHILE GETTING INITIAL MESSAGES")}function g(e){13===e.which&&e.preventDefault()}function p(e=null){var s;s=e||document.getElementById("messenger-text").value,document.getElementById("messenger-text").value="",i&&t&&a&&""!=s?(s=encodeURIComponent(s),$.ajax({type:"POST",url:"api/send_message.php",data:{user_one:t,user_two:a,conversation_id:i,message:s},success:function(e){console.log("STATUS::"+e.trim()),m()},error:function(){alert("There was an error.")}})):console.log("STATUS::ERROR WHILE SENDING MESSAGE")}function u(){if(n){let e=JSON.parse(n);var s=document.getElementById("Messagebox");if(s.innerHTML="",e.length,void 0==e.length&&(s.innerHTML+='<h2 class="text-center">Say hi to start conversation</h2>'),void 0!=e.length){r=e[e.length-1].id;for(let a=0;a<e.length;a++){e[a].conversation_id;var i=e[a].id,o=e[a].message;e[a].message;var l=e[a].timestamp,d=e[a].user_from;if(e[a].user_to,!0==o.includes("Image::")){var c=o.replace("Image::","");o='<a data-fancybox="gallery" href="#" data-src="uploads/'+c+'"><img  src="uploads/'+c+'" class="img-fluid" /></a>'}var g=time_ago(l);d==t?s.innerHTML+='<li class="list-group-item msgbox"><div id="'+i+'" class="msgText msgright" style="padding:10px;position: relative;border: 1px solid #e2e0e0";><div class="msg"><div class="preWrap">'+o+'</div></div><div class="secondary-text mt-1" title=" '+l+' ">'+g+' </div><a class="DeleteMsg delete-msg  text-danger fst-italic mt-1" id="'+i+'">delete </a></div></li>':s.innerHTML+='<li class="list-group-item msgbox"><div id="'+i+'" class="msgText msgleft" style="max-width: 80%;padding: 10px;display: block;position: relative;border: 1px solid #cecece";><div class="msg"><div class="preWrap">'+o+'</div></div><span class="secondary-text mt-1" title=" '+l+' ">'+g+" </span></div></li>"}}}else console.log("ERROR IN SHOWING MESSAGE");$(".DeleteMsg").click(function(){msg_id=this.id,console.log(msg_id)})}function m(){i?r?$.ajax({type:"POST",url:"api/get_new_message.php",data:{conversation_id:i,last_message_id:r},success:function(e){if(console.log(e),void 0!=JSON.parse(e).length){var s=JSON.parse(n),t=JSON.parse(e);for(let a=0;a<t.length;a++)s.push(t[a]);n=JSON.stringify(s),l("scrollingComponent"),u()}},error:function(){alert("There was an error.")}}):c():console.log("STATUS::ANATHER USER NOT SELECTED"),setTimeout(m,5e3)}$(".sendButton").click(function(){""!=document.getElementById("messenger-text").value.trim()?(p(),$("#Imagepicker").hasClass("d-none")&&($("#Imagepicker").removeClass("d-none"),$("#Sendbutton").addClass("d-none"))):(document.getElementById("messenger-text").value="",$("#Imagepicker").hasClass("d-none")&&($("#Imagepicker").removeClass("d-none"),$("#Sendbutton").addClass("d-none")))}),$("#messenger-text").bind("input propertychange",function(){this.value.length?$("#Sendbutton").hasClass("d-none")&&($("#Sendbutton").removeClass("d-none"),$("#Imagepicker").addClass("d-none")):$("#Imagepicker").hasClass("d-none")&&($("#Imagepicker").removeClass("d-none"),$("#Sendbutton").addClass("d-none"))}),document.getElementById("send_image").onchange=function(){var e=this.files[0],s=new FormData;s.append("userImage",e),e&&(console.log(e),$.ajax({type:"POST",url:"upload.php",data:s,processData:!1,contentType:!1,success:function(e){console.log("Image::"+e),p(picture="Image::"+e)},error:function(){alert("There was an error.")}}))},Fancybox.bind('[data-fancybox="gallery"]',{infinite:!1})});